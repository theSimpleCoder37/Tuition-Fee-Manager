<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iqra Tuition Classes</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }
        /* Mobile sidebar, hidden by default */
        .sidebar {
            transition: transform 0.3s ease-in-out;
            transform: translateX(-100%);
            position: fixed;
            top: 0;
            left: 0;
            width: 16rem;
            z-index: 50; /* A high z-index to ensure it's on top */
        }
        .sidebar.open {
            transform: translateX(0);
        }
        /* Desktop sidebar is always visible */
        @media (min-width: 768px) {
            .sidebar {
                transform: translateX(0);
            }
            .content-area {
                margin-left: 16rem; /* Match sidebar width to prevent content overlap */
            }
        }
    </style>
</head>
<body class="bg-gray-50 flex h-screen overflow-hidden">

    <!-- The main application container -->
    <div id="app" class="flex flex-1">
        <!-- Content will be rendered here by JavaScript -->
    </div>

    <!-- Modals for user interaction -->
    <!-- Add Batch Modal -->
    <div id="add-batch-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4 modal-overlay">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4">Add New Batch</h3>
            <form id="add-batch-form">
                <input type="text" id="batch-name-input" placeholder="Enter batch name" required class="w-full px-3 py-2 border border-gray-300 rounded-md mb-4 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancel-add-batch" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 transition-colors">Cancel</button>
                    <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors">Add</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirm-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4 modal-overlay">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
            <h3 class="text-xl font-bold mb-4" id="confirm-modal-title">Confirm Action</h3>
            <p class="text-gray-700 mb-4" id="confirm-modal-message">Are you sure you want to proceed?</p>
            <div class="flex justify-end space-x-2">
                <button type="button" id="cancel-confirm" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 transition-colors">Cancel</button>
                <button type="button" id="execute-confirm" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition-colors">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Student Form Modal -->
    <div id="student-form-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center p-4 modal-overlay">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg">
            <h3 class="text-xl font-bold mb-4" id="student-form-title">Add New Student</h3>
            <div id="student-form-message" class="hidden mb-4 p-3 rounded-lg text-sm text-center"></div>
            <form id="student-form" class="space-y-4">
                <div>
                    <label for="student-name" class="block text-sm font-medium text-gray-700">Student Name</label>
                    <input type="text" id="student-name" name="name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label for="student-class" class="block text-sm font-medium text-gray-700">Class</label>
                    <input type="text" id="student-class" name="class" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label for="student-phone" class="block text-sm font-medium text-gray-700">Phone</label>
                    <input type="tel" id="student-phone" name="phone" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="student-joining-date" class="block text-sm font-medium text-gray-700">Joining Date</label>
                        <input type="date" id="student-joining-date" name="joiningDate" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="student-monthly-fee" class="block text-sm font-medium text-gray-700">Monthly Fee (â‚¹)</label>
                        <input type="number" id="student-monthly-fee" name="monthlyFee" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                </div>
                <div>
                    <label for="student-batch" class="block text-sm font-medium text-gray-700">Assign to Batch</label>
                    <select id="student-batch" name="batchId" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                        <option value="">-- Select Batch --</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancel-student-form" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 transition-colors">Cancel</button>
                    <button type="submit" id="save-student-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition-colors">Save</button>
                </div>
            </form>
        </div>
    </div>


    <!-- Library scripts -->
    <script src="https://cdn.jsdelivr.net/npm/dexie@3.2.2/dist/dexie.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <script>
        // ===========================================================================================================
        // 1. DATABASE & AUTHENTICATION MODULES
        // ===========================================================================================================

        const db = new Dexie('TuitionFeeDB');
        // V3: Added 'status' to the students table to track active/inactive students.
        // V4: Added 'status' field to the fees table to mark stopped fees.
        db.version(4).stores({
            users: '++id, username, pinHash',
            batches: '++id, userId, name',
            students: '++id, userId, batchId, name, class, phone, joiningDate, monthlyFee, status',
            fees: '++id, userId, studentId, year, month, status, fee'
        }).upgrade(async tx => {
            // Upgrade existing fees to have a status. Assuming all existing are 'Paid' or 'Unpaid'.
            const fees = await tx.fees.toArray();
            await tx.fees.bulkPut(fees.map(fee => ({ ...fee, status: fee.status || 'Unpaid' })));
        });

        const auth = (() => {
            let currentUser = null;

            const hashPin = (pin) => {
                return CryptoJS.SHA256(pin).toString(CryptoJS.enc.Hex);
            };

            const register = async (username, pin) => {
                if (!username || pin.length !== 4) {
                    return { success: false, message: "Username and a 4-digit PIN are required." };
                }
                const existingUser = await db.users.where('username').equalsIgnoreCase(username).first();
                if (existingUser) {
                    return { success: false, message: "Username already exists." };
                }
                const pinHash = hashPin(pin);
                const userId = await db.users.add({ username, pinHash });
                return { success: true, userId, message: "Registration successful. You can now log in." };
            };

            const login = async (username, pin) => {
                const user = await db.users.where('username').equalsIgnoreCase(username).first();
                if (!user) {
                    return { success: false, message: "Invalid username or PIN." };
                }
                const pinHash = hashPin(pin);
                if (user.pinHash !== pinHash) {
                    return { success: false, message: "Invalid username or PIN." };
                }
                currentUser = user;
                return { success: true, message: "Login successful!" };
            };

            const logout = () => {
                currentUser = null;
                ui.render();
            };

            const getUserId = () => currentUser ? currentUser.id : null;
            const getCurrentUser = () => currentUser;

            return { register, login, logout, getUserId, getCurrentUser };
        })();

        // ===========================================================================================================
        // 2. DATA MANAGEMENT MODULES (Batches, Students, Fees)
        // ===========================================================================================================

        const dataManager = (() => {
            const getBatches = async () => {
                const userId = auth.getUserId();
                return userId ? await db.batches.where('userId').equals(userId).toArray() : [];
            };

            const addBatch = async (name) => {
                const userId = auth.getUserId();
                if (userId) {
                    await db.batches.add({ userId, name });
                }
            };

            const getStudents = async () => {
                const userId = auth.getUserId();
                return userId ? await db.students.where('userId').equals(userId).toArray() : [];
            };
            
            const getActiveStudents = async () => {
                const userId = auth.getUserId();
                return userId ? await db.students.where({ userId, status: 'Active' }).toArray() : [];
            };

            const getStudentsByBatch = async (batchId) => {
                const userId = auth.getUserId();
                return userId ? await db.students.where({ userId, batchId }).toArray() : [];
            };

            const addStudent = async (student) => {
                const userId = auth.getUserId();
                if (!userId) return;
                const studentId = await db.students.add({
                    userId,
                    batchId: parseInt(student.batchId) || null,
                    name: student.name,
                    class: student.class,
                    phone: student.phone,
                    joiningDate: student.joiningDate,
                    monthlyFee: parseInt(student.monthlyFee),
                    status: 'Active' // New status field, defaults to Active
                });
                await generateInitialFees(studentId, student.joiningDate, parseInt(student.monthlyFee));
            };

            const updateStudent = async (id, student) => {
                const userId = auth.getUserId();
                if (!userId) {
                    throw new Error("Authentication failed. Please log in.");
                }
                
                const existingStudent = await db.students.get(id);
                if (!existingStudent) {
                    throw new Error(`Student with ID ${id} not found.`);
                }

                if (existingStudent.joiningDate !== student.joiningDate) {
                    await db.fees.where({ userId, studentId: id }).delete();
                    await generateInitialFees(id, student.joiningDate, parseInt(student.monthlyFee));
                } else if (existingStudent.monthlyFee !== parseInt(student.monthlyFee)) {
                    const feesToUpdate = await db.fees
                        .where({ userId, studentId: id })
                        .filter(fee => fee.status === 'Unpaid')
                        .toArray();

                    await db.fees.bulkPut(feesToUpdate.map(fee => ({
                        ...fee,
                        fee: parseInt(student.monthlyFee)
                    })));
                }

                // NEW LOGIC: When a student is marked as Inactive, we now mark all future UNPAID fees as 'Stopped'
                if (existingStudent.status === 'Active' && student.status === 'Inactive') {
                    await markFutureUnpaidFeesAsStopped(id);
                } else if (existingStudent.status === 'Inactive' && student.status === 'Active') {
                     // If they become active again, we revert the 'Stopped' fees back to 'Unpaid'
                    await revertStoppedFeesToUnpaid(id);
                }

                await db.students.update(id, {
                    name: student.name,
                    class: student.class,
                    phone: student.phone,
                    batchId: parseInt(student.batchId) || null,
                    joiningDate: student.joiningDate,
                    monthlyFee: parseInt(student.monthlyFee),
                    status: student.status
                });
            };

            const deleteStudent = async (id) => {
                const userId = auth.getUserId();
                if (userId) {
                    await db.students.delete(id);
                    await db.fees.where({ userId, studentId: id }).delete();
                }
            };
            
            // NEW HELPER FUNCTION: Marks future unpaid fees as 'Stopped'
            const markFutureUnpaidFeesAsStopped = async (studentId) => {
                const userId = auth.getUserId();
                const today = new Date();
                const currentYear = today.getFullYear();
                const currentMonth = today.getMonth();

                const feesToUpdate = await db.fees
                    .where({ userId, studentId, status: 'Unpaid' })
                    .filter(fee => {
                        const feeDate = new Date(fee.year, fee.month);
                        const currentDate = new Date(currentYear, currentMonth);
                        return feeDate.getTime() >= currentDate.getTime();
                    })
                    .toArray();

                await db.fees.bulkPut(feesToUpdate.map(fee => ({
                    ...fee,
                    status: 'Stopped'
                })));
            };

            // NEW HELPER FUNCTION: Reverts stopped fees back to 'Unpaid'
            const revertStoppedFeesToUnpaid = async (studentId) => {
                 const userId = auth.getUserId();
                 const feesToUpdate = await db.fees
                     .where({ userId, studentId, status: 'Stopped' })
                     .toArray();

                 await db.fees.bulkPut(feesToUpdate.map(fee => ({
                     ...fee,
                     status: 'Unpaid'
                 })));
            };

            const getFees = async (studentId) => {
                const userId = auth.getUserId();
                if (!userId || !studentId) return [];

                const student = await db.students.get(studentId);
                if (!student) return [];

                const fees = await db.fees.where({ userId, studentId: studentId }).toArray();
                const feeMap = new Map(fees.map(f => [`${f.year}-${f.month}`, f]));

                const joining = new Date(student.joiningDate);
                const today = new Date();
                const result = [];
                for (let year = joining.getFullYear(); year <= today.getFullYear(); year++) {
                    let startMonth = year === joining.getFullYear() ? joining.getMonth() : 0;
                    let endMonth = year === today.getFullYear() ? today.getMonth() : 11;

                    for (let month = startMonth; month <= endMonth; month++) {
                        const feeRecord = feeMap.get(`${year}-${month}`);
                        const status = feeRecord ? feeRecord.status : 'Unpaid';
                        const feeAmount = feeRecord ? feeRecord.fee : student.monthlyFee;
                        
                        // If student is inactive, we don't generate new records past the current month,
                        // and we rely on the `Stopped` status change for past records.
                        if (student.status === 'Inactive') {
                            const feeDate = new Date(year, month);
                            const currentDate = new Date(today.getFullYear(), today.getMonth());
                            if (feeDate > currentDate) continue;
                        }

                        result.push({
                            studentId,
                            year,
                            month,
                            monthName: new Date(year, month).toLocaleString('default', { month: 'long' }),
                            status,
                            fee: feeAmount
                        });
                    }
                }
                return result;
            };

            const generateInitialFees = async (studentId, joiningDate, monthlyFee) => {
                const joining = new Date(joiningDate);
                const today = new Date();
                const userId = auth.getUserId();
                if (!userId || !studentId || !monthlyFee) return;

                const feesToAdd = [];
                for (let year = joining.getFullYear(); year <= today.getFullYear(); year++) {
                    let startMonth = year === joining.getFullYear() ? joining.getMonth() : 0;
                    let endMonth = year === today.getFullYear() ? today.getMonth() : 11;
                    for (let month = startMonth; month <= endMonth; month++) {
                        feesToAdd.push({
                            studentId,
                            userId,
                            year,
                            month,
                            status: 'Unpaid',
                            fee: monthlyFee
                        });
                    }
                }
                await db.fees.bulkAdd(feesToAdd).catch(Dexie.BulkError, e => {
                     console.error("Some initial fees might already exist.", e);
                });
            };

            const getFeeByMonth = async (studentId, year, month) => {
                const userId = auth.getUserId();
                return userId ? await db.fees.where({ userId, studentId, year, month }).first() : null;
            };

            const updateFeeStatus = async (studentId, year, month, status) => {
                const userId = auth.getUserId();
                if (!userId) return;

                const feeRecord = await getFeeByMonth(studentId, year, month);
                if (feeRecord) {
                    await db.fees.update(feeRecord.id, { status });
                } else {
                    const student = await db.students.get(studentId);
                    if (student) {
                        try {
                            await db.fees.add({
                                studentId,
                                userId,
                                year,
                                month,
                                status,
                                fee: student.monthlyFee
                            });
                        } catch (e) {
                            console.error("Error adding new fee record:", e);
                        }
                    }
                }
            };
            
            // NEW HELPER FUNCTION: gets fees for dashboard reports
            const getFeesForReports = async () => {
                const userId = auth.getUserId();
                if (!userId) return { monthlyData: [], monthlyDues: [] };

                const allFees = await db.fees.where('userId').equals(userId).toArray();
                const feesPaid = allFees.filter(f => f.status === 'Paid');
                // The 'Dues' calculation now excludes 'Stopped' fees
                const feesDue = allFees.filter(f => f.status === 'Unpaid');

                const monthlyData = {};
                const monthlyDues = {};

                const today = new Date();
                const currentMonthKey = `${today.getFullYear()}-${today.getMonth()}`;

                for (let i = 11; i >= 0; i--) {
                    const date = new Date();
                    date.setMonth(today.getMonth() - i);
                    const monthKey = `${date.getFullYear()}-${date.getMonth()}`;
                    const monthName = date.toLocaleString('default', { month: 'short', year: '2-digit' });
                    monthlyData[monthKey] = { month: monthName, total: 0 };
                    monthlyDues[monthKey] = { month: monthName, total: 0 };
                }

                feesPaid.forEach(fee => {
                    const key = `${fee.year}-${fee.month}`;
                    if (monthlyData[key]) {
                        monthlyData[key].total += fee.fee;
                    }
                });

                feesDue.forEach(fee => {
                    const key = `${fee.year}-${fee.month}`;
                    if (monthlyDues[key]) {
                        monthlyDues[key].total += fee.fee;
                    }
                });

                return {
                    monthlyData: Object.values(monthlyData),
                    monthlyDues: Object.values(monthlyDues)
                };
            };


            return {
                getBatches, addBatch,
                getStudents, getActiveStudents, getStudentsByBatch, addStudent, updateStudent, deleteStudent,
                getFees, updateFeeStatus,
                getFeesForReports
            };
        })();

        // ===========================================================================================================
        // 3. UI RENDERING & NAVIGATION MODULE
        // ===========================================================================================================

        const ui = (() => {
            let activeView = 'dashboard';
            let studentsData = [];
            let batchesData = [];
            let chartInstances = {}; // Store chart instances to destroy before re-rendering
            let isSidebarOpen = false;

            const appContainer = document.getElementById('app');
            const addBatchModal = document.getElementById('add-batch-modal');
            const confirmModal = document.getElementById('confirm-modal');
            const studentFormModal = document.getElementById('student-form-modal');
            let confirmCallback = () => {};

            document.getElementById('cancel-add-batch').addEventListener('click', () => addBatchModal.classList.add('hidden'));
            document.getElementById('add-batch-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const batchName = document.getElementById('batch-name-input').value.trim();
                if (batchName) {
                    await dataManager.addBatch(batchName);
                    addBatchModal.classList.add('hidden');
                    render('batches');
                }
            });

            document.getElementById('cancel-confirm').addEventListener('click', () => confirmModal.classList.add('hidden'));
            document.getElementById('execute-confirm').addEventListener('click', () => {
                confirmCallback();
                confirmModal.classList.add('hidden');
            });

            document.getElementById('cancel-student-form').addEventListener('click', () => studentFormModal.classList.add('hidden'));
            document.getElementById('student-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formMessage = document.getElementById('student-form-message');
                formMessage.classList.add('hidden');

                const formData = new FormData(e.target);
                const student = {
                    name: formData.get('name'),
                    class: formData.get('class'),
                    phone: formData.get('phone'),
                    joiningDate: formData.get('joiningDate'),
                    monthlyFee: formData.get('monthlyFee'),
                    batchId: formData.get('batchId')
                };
                const studentId = parseInt(document.getElementById('student-form').dataset.studentId);
                
                try {
                    if (studentId) {
                        const existingStudent = studentsData.find(s => s.id === studentId);
                        student.status = existingStudent.status; // Preserve the status on a normal edit
                        await dataManager.updateStudent(studentId, student);
                    } else {
                        await dataManager.addStudent(student);
                    }
                    studentFormModal.classList.add('hidden');
                    render(activeView);
                } catch (error) {
                    console.error('Error saving student:', error);
                    formMessage.textContent = error.message;
                    formMessage.className = 'block mb-4 p-3 rounded-lg text-sm text-center bg-red-100 text-red-700';
                    formMessage.classList.remove('hidden');
                }
            });


            const showAddBatchModal = () => {
                document.getElementById('batch-name-input').value = '';
                addBatchModal.classList.remove('hidden');
            };

            const showConfirmModal = (message, callback) => {
                document.getElementById('confirm-modal-title').textContent = 'Confirm Action';
                document.getElementById('confirm-modal-message').textContent = message;
                confirmCallback = callback;
                confirmModal.classList.remove('hidden');
            };

            const showStudentFormModal = (student = null) => {
                const batchesSelect = document.getElementById('student-batch');
                batchesSelect.innerHTML = `<option value="">-- Select Batch --</option>` +
                    batchesData.map(b => `<option value="${b.id}">${b.name}</option>`).join('');

                const form = document.getElementById('student-form');
                document.getElementById('student-form-title').textContent = student ? 'Edit Student' : 'Add New Student';
                form.dataset.studentId = student ? student.id : '';
                form.name.value = student ? student.name : '';
                form.class.value = student ? student.class : '';
                form.phone.value = student ? student.phone : '';
                form.joiningDate.value = student ? student.joiningDate : '';
                form.monthlyFee.value = student ? student.monthlyFee : '';
                form.batchId.value = student ? student.batchId || '' : '';
                
                document.getElementById('student-form-message').classList.add('hidden');
                studentFormModal.classList.remove('hidden');
            };

            const toggleSidebar = () => {
                isSidebarOpen = !isSidebarOpen;
                const sidebar = document.querySelector('.sidebar');
                if (sidebar) {
                    sidebar.classList.toggle('open', isSidebarOpen);
                }
            };
            
            const closeSidebar = () => {
                isSidebarOpen = false;
                const sidebar = document.querySelector('.sidebar');
                if (sidebar) {
                    sidebar.classList.remove('open');
                }
            };

            const render = async (view, studentId = null) => {
                activeView = view;
                appContainer.innerHTML = '';
                closeSidebar(); // Ensure sidebar is closed on mobile when navigating

                // Destroy old chart instances to prevent duplicates
                Object.values(chartInstances).forEach(chart => chart.destroy());
                chartInstances = {};

                if (!auth.getCurrentUser()) {
                    appContainer.appendChild(createLoginScreen());
                } else {
                    appContainer.innerHTML = '';
                    appContainer.appendChild(createSidebar());
                    const mainContentArea = document.createElement('div');
                    mainContentArea.className = 'flex-1 p-4 md:p-6 overflow-y-auto content-area';
                    mainContentArea.addEventListener('click', (e) => {
                         if (isSidebarOpen && window.innerWidth < 768) {
                             closeSidebar();
                         }
                    });
                    
                    const mainContent = document.createElement('div');
                    mainContent.id = 'main-content';
                    
                    const hamburger = document.createElement('div');
                    hamburger.className = 'md:hidden fixed top-4 left-4 z-[55]';
                    hamburger.innerHTML = `
                        <button id="hamburger-btn" class="text-gray-900 bg-white p-2 rounded-md shadow-lg">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                        </button>
                    `;
                    hamburger.querySelector('#hamburger-btn').addEventListener('click', (e) => {
                        e.stopPropagation(); // Prevent the main content's click listener from firing
                        toggleSidebar();
                    });
                    mainContentArea.appendChild(hamburger);
                    mainContentArea.appendChild(mainContent);
                    appContainer.appendChild(mainContentArea);


                    switch (activeView) {
                        case 'dashboard':
                            await renderDashboard();
                            break;
                        case 'students':
                            await renderStudents();
                            break;
                        case 'batches':
                            await renderBatches();
                            break;
                        case 'reports':
                            await renderReports();
                            break;
                        case 'fee-manager':
                            await renderFeeManager();
                            break;
                        case 'student-details':
                            await renderStudentDetails(studentId);
                            break;
                    }
                }
            };

            const createSidebar = () => {
                const sidebar = document.createElement('div');
                sidebar.className = 'bg-gray-900 text-white w-64 space-y-6 py-7 px-4 h-full z-[55] sidebar md:transform-none';
                sidebar.innerHTML = `
                    <div class="flex items-center space-x-2 px-2 mb-6">
                        <span class="text-3xl font-extrabold text-indigo-400">Iqra Tuition Classes</span>
                    </div>
                    <nav class="space-y-2">
                        <a href="#" data-view="dashboard" class="block py-2.5 px-4 rounded-md transition duration-200 hover:bg-gray-700 hover:text-white">Dashboard</a>
                        <a href="#" data-view="students" class="block py-2.5 px-4 rounded-md transition duration-200 hover:bg-gray-700 hover:text-white">Students</a>
                        <a href="#" data-view="fee-manager" class="block py-2.5 px-4 rounded-md transition duration-200 hover:bg-gray-700 hover:text-white">Fee Management</a>
                        <a href="#" data-view="batches" class="block py-2.5 px-4 rounded-md transition duration-200 hover:bg-gray-700 hover:text-white">Batches</a>
                        <a href="#" data-view="reports" class="block py-2.5 px-4 rounded-md transition duration-200 hover:bg-gray-700 hover:text-white">Reports</a>
                    </nav>
                    <div class="absolute bottom-4 left-4 right-4">
                        <button id="logout-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md shadow-lg transition-colors">Logout</button>
                    </div>
                `;
                sidebar.querySelectorAll('a[data-view]').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        render(e.target.dataset.view);
                        if (window.innerWidth < 768) {
                            closeSidebar();
                        }
                    });
                });
                sidebar.querySelector('#logout-btn').addEventListener('click', auth.logout);
                return sidebar;
            };

            const createLoginScreen = () => {
                const loginScreen = document.createElement('div');
                loginScreen.className = 'flex flex-1 items-center justify-center bg-gray-50';
                loginScreen.innerHTML = `
                    <div class="w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-lg">
                        <h2 class="text-3xl font-bold text-center text-gray-900">Iqra Tuition Classes</h2>
                        <div id="auth-message" class="text-center text-red-500 font-medium"></div>
                        <form id="auth-form" class="space-y-6">
                            <div>
                                <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                                <input id="username" name="username" type="text" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div>
                                <label for="pin" class="block text-sm font-medium text-gray-700">4-Digit PIN</label>
                                <input id="pin" name="pin" type="password" pattern="\\d{4}" maxlength="4" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
                            </div>
                            <div class="flex items-center justify-between">
                                <button type="submit" id="login-btn" class="w-full mr-2 py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Log In</button>
                                <button type="button" id="register-btn" class="w-full ml-2 py-2 px-4 border border-indigo-600 rounded-md shadow-sm text-sm font-medium text-indigo-600 bg-white hover:bg-indigo-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Register</button>
                            </div>
                        </form>
                    </div>
                `;
                loginScreen.querySelector('#auth-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const username = e.target.username.value;
                    const pin = e.target.pin.value;
                    const result = await auth.login(username, pin);
                    if (result.success) {
                        render('dashboard');
                    }
                    loginScreen.querySelector('#auth-message').textContent = result.message;
                });
                loginScreen.querySelector('#register-btn').addEventListener('click', async (e) => {
                    e.preventDefault();
                    const username = loginScreen.querySelector('#username').value;
                    const pin = loginScreen.querySelector('#pin').value;
                    const result = await auth.register(username, pin);
                    loginScreen.querySelector('#auth-message').textContent = result.message;
                });
                return loginScreen;
            };

            const renderDashboard = async () => {
                const mainContent = document.getElementById('main-content');
                mainContent.innerHTML = `<h1 class="text-3xl font-bold text-gray-900 mb-6">Dashboard</h1>`;
                const students = await dataManager.getActiveStudents(); // Get only active students for dashboard
                const allStudents = await dataManager.getStudents();
                const batches = await dataManager.getBatches();
                const fees = await dataManager.getFeesForReports();
                const monthlyFeesData = fees.monthlyData;
                const monthlyDuesData = fees.monthlyDues;

                const totalStudents = allStudents.length;
                const activeStudents = students.length;
                const totalBatches = batches.length;
                const totalPaid = monthlyFeesData.reduce((sum, item) => sum + item.total, 0);
                const totalDues = monthlyDuesData.reduce((sum, item) => sum + item.total, 0);

                mainContent.innerHTML += `
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
                        <div class="bg-white rounded-xl shadow-lg p-6 text-center">
                            <h3 class="text-lg font-semibold text-gray-500 mb-2">Total Students</h3>
                            <p class="text-4xl font-extrabold text-indigo-600">${totalStudents}</p>
                        </div>
                        <div class="bg-white rounded-xl shadow-lg p-6 text-center">
                            <h3 class="text-lg font-semibold text-gray-500 mb-2">Active Students</h3>
                            <p class="text-4xl font-extrabold text-green-600">${activeStudents}</p>
                        </div>
                        <div class="bg-white rounded-xl shadow-lg p-6 text-center">
                            <h3 class="text-lg font-semibold text-gray-500 mb-2">Total Batches</h3>
                            <p class="text-4xl font-extrabold text-indigo-600">${totalBatches}</p>
                        </div>
                        <div class="bg-white rounded-xl shadow-lg p-6 text-center">
                            <h3 class="text-lg font-semibold text-gray-500 mb-2">Fees Collected</h3>
                            <p class="text-4xl font-extrabold text-green-600">â‚¹${totalPaid.toLocaleString()}</p>
                        </div>
                        <div class="bg-white rounded-xl shadow-lg p-6 text-center">
                            <h3 class="text-lg font-semibold text-gray-500 mb-2">Total Dues</h3>
                            <p class="text-4xl font-extrabold text-red-600">â‚¹${totalDues.toLocaleString()}</p>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-8">
                        <h2 class="text-2xl font-bold mb-6">Monthly Fee Summary</h2>
                        <div class="h-80">
                            <canvas id="monthlyFeeChart"></canvas>
                        </div>
                    </div>
                `;

                // Render Chart.js graph
                const monthlyChartCtx = document.getElementById('monthlyFeeChart').getContext('2d');
                chartInstances.monthlyFeeChart = new Chart(monthlyChartCtx, {
                    type: 'bar',
                    data: {
                        labels: monthlyFeesData.map(d => d.month),
                        datasets: [
                            {
                                label: 'Fees Collected',
                                data: monthlyFeesData.map(d => d.total),
                                backgroundColor: '#48BB78',
                                borderColor: '#38A169',
                                borderWidth: 1
                            },
                            {
                                label: 'Fees Due',
                                data: monthlyDuesData.map(d => d.total),
                                backgroundColor: '#F56565',
                                borderColor: '#E53E3E',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    font: { size: 14, family: 'Inter' }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: '#e2e8f0'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            };

            const renderStudents = async () => {
                const mainContent = document.getElementById('main-content');
                studentsData = await dataManager.getStudents();
                batchesData = await dataManager.getBatches();

                mainContent.innerHTML = `
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                        <h1 class="text-3xl font-bold text-gray-900 mb-4 sm:mb-0">Students</h1>
                        <div class="flex flex-col sm:flex-row gap-2 items-stretch sm:items-center w-full sm:w-auto">
                            <select id="batch-filter" class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 w-full sm:w-auto">
                                <option value="all">All Batches</option>
                                ${batchesData.map(b => `<option value="${b.id}">${b.name}</option>`).join('')}
                            </select>
                            <select id="status-filter" class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 w-full sm:w-auto">
                                <option value="all">All Students</option>
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                            </select>
                            <button id="add-student-btn" class="bg-indigo-600 text-white px-5 py-2 rounded-lg shadow-md hover:bg-indigo-700 transition-colors w-full sm:w-auto">Add New Student</button>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead>
                                <tr>
                                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Batch</th>
                                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Class</th>
                                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 bg-gray-50"></th>
                                </tr>
                            </thead>
                            <tbody id="students-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Student rows will be added here -->
                            </tbody>
                        </table>
                    </div>
                `;
                
                const renderFilteredStudents = (filterBatchId, filterStatus) => {
                    const tableBody = mainContent.querySelector('#students-table-body');
                    tableBody.innerHTML = '';
                    let studentsToRender = studentsData;
                    if (filterBatchId !== 'all') {
                        studentsToRender = studentsToRender.filter(s => s.batchId == filterBatchId);
                    }
                    if (filterStatus !== 'all') {
                        studentsToRender = studentsToRender.filter(s => s.status === filterStatus);
                    }
                    
                    if (studentsToRender.length === 0) {
                        tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">No students found.</td></tr>`;
                    } else {
                        studentsToRender.forEach(student => {
                            const batch = batchesData.find(b => b.id === student.batchId);
                            const statusColor = student.status === 'Active' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td class="px-6 py-4 whitespace-nowrap">${student.name}</td>
                                <td class="px-6 py-4 whitespace-nowrap">${batch ? batch.name : 'Unassigned'}</td>
                                <td class="px-6 py-4 whitespace-nowrap">${student.class}</td>
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusColor}">
                                        ${student.status}
                                    </span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                    <button data-id="${student.id}" class="text-indigo-600 hover:text-indigo-900 student-view-btn font-medium">View</button>
                                    <button data-id="${student.id}" class="text-indigo-600 hover:text-indigo-900 ml-4 student-edit-btn font-medium">Edit</button>
                                    <button data-id="${student.id}" class="text-red-600 hover:text-red-900 ml-4 student-delete-btn font-medium">Delete</button>
                                </td>
                            `;
                            tableBody.appendChild(row);
                        });
                        // Add event listeners after populating the table
                        mainContent.querySelectorAll('.student-view-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                const studentId = parseInt(e.target.dataset.id);
                                render('student-details', studentId);
                            });
                        });
                        mainContent.querySelectorAll('.student-edit-btn').forEach(btn => {
                            btn.addEventListener('click', async (e) => {
                                const studentId = parseInt(e.target.dataset.id);
                                const student = await db.students.get(studentId);
                                showStudentFormModal(student);
                            });
                        });
                        mainContent.querySelectorAll('.student-delete-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                const studentId = parseInt(e.target.dataset.id);
                                showConfirmModal('Are you sure you want to delete this student? This action cannot be undone.', async () => {
                                    await dataManager.deleteStudent(studentId);
                                    render('students');
                                });
                            });
                        });
                    }
                };

                const batchFilter = mainContent.querySelector('#batch-filter');
                const statusFilter = mainContent.querySelector('#status-filter');
                
                mainContent.querySelector('#add-student-btn').addEventListener('click', () => showStudentFormModal());
                batchFilter.addEventListener('change', (e) => {
                    renderFilteredStudents(e.target.value, statusFilter.value);
                });
                statusFilter.addEventListener('change', (e) => {
                    renderFilteredStudents(batchFilter.value, e.target.value);
                });
                renderFilteredStudents('all', 'all');
            };
            
            const renderFeeManager = async () => {
                const mainContent = document.getElementById('main-content');
                studentsData = await dataManager.getStudents();
                batchesData = await dataManager.getBatches();
                
                mainContent.innerHTML = `
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                        <h1 class="text-3xl font-bold text-gray-900 mb-4 sm:mb-0">Fee Management</h1>
                        <div class="flex flex-wrap gap-2 items-center mt-2 sm:mt-0">
                            <select id="batch-filter" class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="all">All Batches</option>
                                ${batchesData.map(b => `<option value="${b.id}">${b.name}</option>`).join('')}
                            </select>
                            <select id="status-filter" class="px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="Active">Active Students</option>
                                <option value="all">All Students</option>
                                <option value="Inactive">Inactive Students</option>
                            </select>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead>
                                <tr>
                                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Batch</th>
                                    <th class="px-6 py-3 bg-gray-50 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Due Months</th>
                                    <th class="px-6 py-3 bg-gray-50"></th>
                                </tr>
                            </thead>
                            <tbody id="fee-manager-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Student rows will be added here -->
                            </tbody>
                        </table>
                    </div>
                `;
                
                const renderFilteredStudents = async (filterBatchId, filterStatus) => {
                    const tableBody = mainContent.querySelector('#fee-manager-table-body');
                    tableBody.innerHTML = '';
                    let studentsToRender = studentsData;

                    if (filterBatchId !== 'all') {
                        studentsToRender = studentsToRender.filter(s => s.batchId == filterBatchId);
                    }
                    if (filterStatus !== 'all') {
                        studentsToRender = studentsToRender.filter(s => s.status === filterStatus);
                    }
                    
                    if (studentsToRender.length === 0) {
                        tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">No students found in this batch.</td></tr>`;
                    } else {
                        for (const student of studentsToRender) {
                            const fees = await dataManager.getFees(student.id);
                            // The due count now only considers 'Unpaid' fees, not 'Stopped' ones
                            const dueMonths = fees.filter(f => f.status === 'Unpaid');
                            const batch = batchesData.find(b => b.id === student.batchId);
                            
                            const row = document.createElement('tr');
                            const dueCount = dueMonths.length;
                            const dueText = dueCount === 0 ? 'All Paid' : `${dueCount} month(s) due`;
                            const dueClass = dueCount === 0 ? 'text-green-600' : 'text-red-600';
                            
                            row.innerHTML = `
                                <td class="px-6 py-4 whitespace-nowrap">${student.name}</td>
                                <td class="px-6 py-4 whitespace-nowrap">${batch ? batch.name : 'Unassigned'}</td>
                                <td class="px-6 py-4 whitespace-nowrap ${dueClass} font-medium">${dueText}</td>
                                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                    <button data-id="${student.id}" class="text-indigo-600 hover:text-indigo-900 fee-manager-view-btn font-medium">View & Update</button>
                                </td>
                            `;
                            tableBody.appendChild(row);
                        }
                        
                        mainContent.querySelectorAll('.fee-manager-view-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                const studentId = parseInt(e.target.dataset.id);
                                render('student-details', studentId);
                            });
                        });
                    }
                };
                
                const batchFilter = mainContent.querySelector('#batch-filter');
                const statusFilter = mainContent.querySelector('#status-filter');
                
                statusFilter.value = 'Active'; // Default filter
                
                batchFilter.addEventListener('change', (e) => {
                    renderFilteredStudents(e.target.value, statusFilter.value);
                });
                statusFilter.addEventListener('change', (e) => {
                    renderFilteredStudents(batchFilter.value, e.target.value);
                });
                renderFilteredStudents('all', 'Active');
            };

            const renderStudentDetails = async (studentId) => {
                const mainContent = document.getElementById('main-content');
                const student = studentsData.find(s => s.id === studentId);
                if (!student) {
                    mainContent.innerHTML = `<p class="text-red-500">Student not found.</p>`;
                    return;
                }
                const fees = await dataManager.getFees(studentId);
                const batches = await dataManager.getBatches();
                const studentBatch = batches.find(b => b.id === student.batchId);
                
                const statusButtonText = student.status === 'Active' ? 'Mark Inactive' : 'Mark Active';
                const statusButtonColor = student.status === 'Active' ? 'bg-red-600 hover:bg-red-700' : 'bg-green-600 hover:bg-green-700';

                mainContent.innerHTML = `
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                        <h1 class="text-3xl font-bold text-gray-900 mb-4 sm:mb-0">${student.name}</h1>
                        <div class="flex flex-wrap gap-2 items-center mt-2 sm:mt-0">
                            <button id="back-to-list" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg shadow-sm hover:bg-gray-300">Back</button>
                            <button id="edit-student-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg shadow-sm hover:bg-indigo-700 transition-colors">Edit Student</button>
                            <button id="toggle-status-btn" class="text-white px-4 py-2 rounded-lg shadow-sm ${statusButtonColor} transition-colors">${statusButtonText}</button>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <h2 class="text-xl font-bold mb-4">Student Information</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-gray-700">
                            <p><strong>Status:</strong> <span class="font-medium ${student.status === 'Active' ? 'text-green-600' : 'text-red-600'}">${student.status}</span></p>
                            <p><strong>Batch:</strong> ${studentBatch ? studentBatch.name : 'Unassigned'}</p>
                            <p><strong>Class:</strong> ${student.class}</p>
                            <p><strong>Phone:</strong> ${student.phone}</p>
                            <p><strong>Joining Date:</strong> ${new Date(student.joiningDate).toDateString()}</p>
                            <p><strong>Monthly Fee:</strong> â‚¹${student.monthlyFee}</p>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-xl font-bold mb-4">Fee Records</h2>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead>
                                    <tr>
                                        <th class="px-6 py-3 bg-gray-50 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Month</th>
                                        <th class="px-6 py-3 bg-gray-50 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Fee</th>
                                        <th class="px-6 py-3 bg-gray-50 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Status</th>
                                        <th class="px-6 py-3 bg-gray-50"></th>
                                    </tr>
                                </thead>
                                <tbody id="fee-records-body" class="bg-white divide-y divide-gray-200">
                                    <!-- Fee rows will be added here -->
                                    <tr class="hidden" id="fee-loading-row"><td colspan="4" class="text-center py-4 text-gray-500">Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;

                const feeTableBody = mainContent.querySelector('#fee-records-body');
                fees.sort((a,b) => new Date(a.year, a.month) - new Date(b.year, b.month)).forEach(fee => {
                    const row = document.createElement('tr');
                    let statusClass;
                    // NEW: Status color and text now handle the 'Stopped' state
                    if (fee.status === 'Paid') {
                        statusClass = 'bg-green-200 text-green-800';
                    } else if (fee.status === 'Unpaid') {
                        statusClass = 'bg-red-200 text-red-800';
                    } else {
                        statusClass = 'bg-yellow-100 text-yellow-800';
                    }

                    // Only show the toggle button for 'Paid' or 'Unpaid' statuses
                    const actionButton = (fee.status === 'Paid' || fee.status === 'Unpaid') ?
                        `<button data-year="${fee.year}" data-month="${fee.month}" data-status="${fee.status}" class="fee-toggle-btn text-indigo-600 hover:text-indigo-900 font-medium">
                            ${fee.status === 'Paid' ? 'Mark Unpaid' : 'Mark Paid'}
                         </button>` :
                         `<span>N/A</span>`;

                    
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">${fee.monthName} ${fee.year}</td>
                        <td class="px-6 py-4 whitespace-nowrap">â‚¹${fee.fee}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">
                                ${fee.status}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                            ${actionButton}
                        </td>
                    `;
                    feeTableBody.appendChild(row);
                });

                mainContent.querySelector('#back-to-list').addEventListener('click', () => render(activeView === 'students' ? 'students' : 'fee-manager'));
                mainContent.querySelector('#edit-student-btn').addEventListener('click', () => showStudentFormModal(student));
                mainContent.querySelector('#toggle-status-btn').addEventListener('click', async () => {
                    const newStatus = student.status === 'Active' ? 'Inactive' : 'Active';
                    const message = newStatus === 'Inactive'
                        ? `Are you sure you want to mark this student as ${newStatus}? This will stop future fee collection for them.`
                        : `Are you sure you want to mark this student as ${newStatus}? This will reactivate fee collection.`
                    showConfirmModal(message, async () => {
                        await dataManager.updateStudent(student.id, { ...student, status: newStatus });
                        render('student-details', studentId);
                    });
                });
                mainContent.querySelectorAll('.fee-toggle-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const year = parseInt(e.target.dataset.year);
                        const month = parseInt(e.target.dataset.month);
                        const currentStatus = e.target.dataset.status;
                        const newStatus = currentStatus === 'Paid' ? 'Unpaid' : 'Paid';
                        await dataManager.updateFeeStatus(studentId, year, month, newStatus);
                        render('student-details', studentId);
                    });
                });
            };

            const renderBatches = async () => {
                const mainContent = document.getElementById('main-content');
                batchesData = await dataManager.getBatches();
                mainContent.innerHTML = `
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
                        <h1 class="text-3xl font-bold text-gray-900 mb-4 sm:mb-0">Batches</h1>
                        <button id="add-batch-btn" class="bg-indigo-600 text-white px-5 py-2 rounded-lg shadow-md hover:bg-indigo-700 transition-colors w-full sm:w-auto">Add New Batch</button>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <ul id="batch-list" class="divide-y divide-gray-200">
                            <!-- Batch list will be added here -->
                        </ul>
                    </div>
                `;
                const batchList = mainContent.querySelector('#batch-list');
                if (batchesData.length === 0) {
                     batchList.innerHTML = `<li class="py-4 text-gray-500 text-center">No batches created yet.</li>`;
                } else {
                    batchesData.forEach(batch => {
                        const li = document.createElement('li');
                        li.className = 'py-4 flex items-center justify-between';
                        li.innerHTML = `
                            <div class="text-lg font-medium text-gray-900">${batch.name}</div>
                            <button data-id="${batch.id}" class="text-red-600 hover:text-red-900 batch-delete-btn font-medium">Delete</button>
                        `;
                        batchList.appendChild(li);
                    });
                }
                mainContent.querySelector('#add-batch-btn').addEventListener('click', showAddBatchModal);
                mainContent.querySelectorAll('.batch-delete-btn').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        const batchId = parseInt(e.target.dataset.id);
                        showConfirmModal('Are you sure you want to delete this batch? Students in this batch will be unassigned.', async () => {
                            await db.batches.delete(batchId);
                            // Set batchId of students to null
                            const studentsInBatch = await dataManager.getStudentsByBatch(batchId);
                            await db.students.bulkPut(studentsInBatch.map(s => ({...s, batchId: null})));
                            render('batches');
                        });
                    });
                });
            };
            
            const renderReports = async () => {
                const mainContent = document.getElementById('main-content');
                const students = await dataManager.getStudents();
                const fees = await db.fees.where('userId').equals(auth.getUserId()).toArray();

                mainContent.innerHTML = `
                    <h1 class="text-3xl font-bold text-gray-900 mb-6">Reports</h1>
                    <div class="bg-white p-6 rounded-xl shadow-lg mb-6">
                        <h2 class="text-2xl font-bold mb-4">Export Data</h2>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <button id="export-students-csv" class="bg-indigo-600 text-white px-5 py-3 rounded-lg shadow-md hover:bg-indigo-700 transition-colors">Export Students (CSV)</button>
                            <button id="export-fees-csv" class="bg-indigo-600 text-white px-5 py-3 rounded-lg shadow-md hover:bg-indigo-700 transition-colors">Export Fees (CSV)</button>
                        </div>
                    </div>
                `;
                
                mainContent.querySelector('#export-students-csv').addEventListener('click', () => {
                    const studentData = students.map(s => ({
                        'ID': s.id,
                        'Name': s.name,
                        'Class': s.class,
                        'Phone': s.phone,
                        'Joining Date': s.joiningDate,
                        'Monthly Fee': s.monthlyFee,
                        'Status': s.status
                    }));
                    downloadCSV(Papa.unparse(studentData), 'students.csv');
                });

                mainContent.querySelector('#export-fees-csv').addEventListener('click', () => {
                    const feeData = fees.map(f => ({
                        'Student ID': f.studentId,
                        'Year': f.year,
                        'Month': f.month,
                        'Fee Amount': f.fee,
                        'Status': f.status
                    }));
                    downloadCSV(Papa.unparse(feeData), 'fees.csv');
                });
            };

            const downloadCSV = (csv, filename) => {
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                if (link.download !== undefined) {
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', filename);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            };


            return { render };
        })();
        
        // Initial render on page load
        document.addEventListener('DOMContentLoaded', () => {
             ui.render('dashboard');
        });
    </script>
</body>
</html>
